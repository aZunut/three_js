<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Hand Tracking with A-Frame and Three.js</title>
    <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
    <script src="https://threejs.org/build/three.js"></script>
    <meta http-equiv="Feature-Policy" content="xr-spatial-tracking *">
    <style>
        #coordinates {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 10px;
            font-family: monospace;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="coordinates">Waiting for hand tracking...</div>

    <!-- A-Frame Scene -->
    <a-scene vr-mode-ui="enabled: true" renderer="antialias: true">
        <!-- カメラ -->
        <a-entity camera position="0 1.6 0" wasd-controls-enabled="false"></a-entity>
    </a-scene>

    <script>
        const coordDisplay = document.getElementById('coordinates');
        const sceneEl = document.querySelector('a-scene');

        // ハンドトラッキングを有効化
        if (navigator.xr) {
            navigator.xr.requestSession('immersive-vr', {
                requiredFeatures: ['hand-tracking', 'local-floor']
            }).then((session) => {
                // A-FrameのVRセッションとしてセット
                sceneEl.renderer.xr.setSession(session);
                coordDisplay.textContent = 'Hand tracking started...';

                session.addEventListener('inputsourceschange', (event) => {
                    event.added.forEach((inputSource) => {
                        if (inputSource.hand) {
                            coordDisplay.textContent = 'Hand detected!';
                        }
                    });
                });

                // ハンドトラッキング座標取得と表示
                function handleHands(frame) {
                    let coordText = '';
                    for (const inputSource of session.inputSources) {
                        if (inputSource.hand) {
                            coordText += `Hand: ${inputSource.handedness}\n`;
                            for (const [jointName, joint] of inputSource.hand.entries()) {
                                if (joint && joint.transform) {
                                    const pos = joint.transform.position;
                                    coordText += `${jointName}: (${pos.x.toFixed(3)}, ${pos.y.toFixed(3)}, ${pos.z.toFixed(3)})\n`;
                                }
                            }
                            coordText += '\n';
                        }
                    }
                    coordDisplay.textContent = coordText;
                }

                // レンダリングループ
                function animate() {
                    const frame = session.requestAnimationFrame((time, frame) => {
                        handleHands(frame);
                        animate();
                    });
                }
                animate();
            }).catch((err) => {
                coordDisplay.textContent = `Error: ${err.message}`;
            });
        } else {
            coordDisplay.textContent = 'WebXR not supported on this device.';
        }
    </script>
</body>
</html>
